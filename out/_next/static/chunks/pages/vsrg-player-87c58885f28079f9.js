(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[944],{9406:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/vsrg-player",function(){return n(9945)}])},9945:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return ew}});var r,s,i=n(4111),a=n(7568),o=n(1438),c=n(8668),l=n(6042),u=n(9396),d=n(6626),h=n(655),g=n(5893),f=n(7294),m=n(828),y=n(8461),p=n(781),b=n(125),v=n(7671),x=n(1866),j=n(750),S=n(1108),k=n(9218),w=n(1014),O=n(5453),C=n(7053),z=n(4931),N=n(7008),Z=n(5055),H=n(2132),L=n(1182),P=n(9583),E=n(1664),F=n.n(E),_=n(2809),A=n(2650),T=n(2169),R=n(4339),I=(0,f.memo)(function(e){var t=e.onSongSelect,n=e.settings,r=e.onSettingsUpdate,s=(0,m.Z)((0,f.useState)(!1),2),i=s[0],a=s[1],o=(0,m.Z)((0,f.useState)(!0),2),c=o[0],l=o[1],u=(0,m.Z)((0,f.useState)("Settings"),2),d=u[0],h=u[1],j=(0,m.Z)((0,z.j)(),1)[0],S=(0,m.Z)((0,N.n)(),1)[0],w=(0,m.Z)((0,Z.F)(),1)[0],H=(0,C.ZP)(function(e){if(T.q$)return l(!1);a(!1)},{active:i&&c,ignoreFocusable:!0}),L=(0,f.useCallback)(function(e){if(e===d&&i)return a(!1);a(!0),e&&(h(e),O.Z.UIEvent("menu",{tab:e}))},[i,d]);return(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("div",{className:"menu-wrapper",ref:H,children:[(0,g.jsx)("div",{className:"hamburger-top",onClick:function(){return l(!c)},children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(P.Fm7,{})})}),(0,g.jsxs)("div",{className:"menu ".concat(c?"menu-visible":""),children:[(0,g.jsx)(v.s,{onClick:function(){l(!1)},ariaLabel:"Close Menu",children:(0,g.jsx)(P.aHS,{className:"icon"})}),(0,g.jsx)(v.s,{style:{marginTop:"auto"},onClick:function(){return L("Songs")},isActive:i&&"Songs"===d,ariaLabel:"Song menu",children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(P.HcQ,{className:"icon"})})}),(0,g.jsx)(v.s,{onClick:function(){return L("Settings")},isActive:i&&"Settings"===d,ariaLabel:"Settings menu",children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(P.p4t,{className:"icon"})})}),(0,g.jsx)(v.s,{onClick:function(){return _.I.open()},ariaLabel:"Open home menu",children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(P.xng,{className:"icon"})})})]}),(0,g.jsxs)("div",{className:i&&c?"side-menu menu-open":"side-menu",children:[(0,g.jsxs)(p.Z,{current:d,id:"Songs",children:[(0,g.jsx)("div",{className:"row",children:(0,g.jsx)(F(),{href:"vsrg-composer",children:(0,g.jsx)(y.J,{children:"Create song"})})}),(0,g.jsx)(b.G,{songs:S,exclude:["composed","recorded"],style:{marginTop:"0.6rem"},SongComponent:M,componentProps:{theme:w,folders:j,functions:{setMenuVisible:l,onSongSelect:t}}})]}),(0,g.jsxs)(p.Z,{current:d,id:"Settings",children:[(0,g.jsx)(x.A,{settings:n,onUpdate:r}),(0,g.jsx)("div",{className:"row",style:{marginTop:"0.6rem",justifyContent:"flex-end"},children:!T.q$&&(0,g.jsx)(F(),{href:"keybinds",children:(0,g.jsx)(y.J,{children:"Change keybinds"})})})]})]})]})})},function(e,t){return e.settings===t.settings});function M(e){var t,n=e.data,r=e.functions,s=e.theme,i=e.folders,o=r.setMenuVisible,c=r.onSongSelect,l={backgroundColor:s.layer("primary",.15).hex()},u=(0,m.Z)((0,f.useState)(!1),2),d=u[0],y=u[1],p=(0,m.Z)((0,f.useState)(n.name),2),b=p[0],v=p[1];return((0,f.useEffect)(function(){v(n.name)},[n.name]),"vsrg"!==n.type)?(0,g.jsx)("div",{className:"row",children:"Invalid song"}):(0,g.jsxs)("div",{className:"song-row",children:[(0,g.jsxs)("div",{className:"song-name ".concat((0,w.h)(!0)),onClick:(0,a.Z)(function(){var e;return(0,h.__generator)(this,function(t){switch(t.label){case 0:if(d)return[2];return[4,L.v.fromStorableSong(n)];case 1:if(!(e=t.sent()))return[2,R.kg.error("Could not find song")];return c(e,"play"),o(!1),[2]}})}),children:[d?(0,g.jsx)("input",{className:"song-name-input ".concat(d?"song-rename":""),disabled:!d,onChange:function(e){return v(e.target.value)},style:{width:"100%",color:"var(--primary-text)"},value:b}):(0,g.jsx)("div",{style:{marginLeft:"0.3rem"},children:b}),(0,g.jsx)(w.u,{children:d?"Song name":"Play song"})]}),(0,g.jsx)("div",{className:"song-buttons-wrapper",children:(0,g.jsxs)(S.Rk,{Icon:P.LCi,style:l,ignoreClickOutside:d,tooltip:"More options",onClose:function(){return y(!1)},children:[(0,g.jsxs)(S.tc,{onClick:function(){d&&(A.k.renameSong(n.id,b),y(!1)),y(!d)},children:[(0,g.jsx)(P.tU3,{style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:d?"Save":"Rename"})]}),(0,g.jsxs)(S.tc,{style:{padding:"0 0.4rem"},children:[(0,g.jsx)(P.$nz,{style:{marginRight:"0.4rem"}}),(0,g.jsxs)("select",{className:"dropdown-select",value:n.folderId||"_None",onChange:(t=(0,a.Z)(function(e){var t,r;return(0,h.__generator)(this,function(s){switch(s.label){case 0:return t=e.target.value,[4,L.v.getOneSerializedFromStorable(n)];case 1:if(!(r=s.sent()))return[2,R.kg.error("Could not find song")];return A.k.addSongToFolder(r,"_None"!==t?t:null),[2]}})}),function(e){return t.apply(this,arguments)}),children:[(0,g.jsx)("option",{value:"_None",children:"None"}),i.map(function(e){return(0,g.jsx)("option",{value:e.id,children:e.name},e.id)})]})]}),(0,g.jsxs)(S.tc,{onClick:(0,a.Z)(function(){var e;return(0,h.__generator)(this,function(t){switch(t.label){case 0:return[4,L.v.getOneSerializedFromStorable(n)];case 1:if(!(e=t.sent()))return[2,R.kg.error("Could not find song")];return H.bV.downloadSong(e,n.name),[2]}})}),children:[(0,g.jsx)(P.aBF,{style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:"Download"})]}),(0,g.jsxs)(S.tc,{onClick:(0,a.Z)(function(){return(0,h.__generator)(this,function(e){switch(e.label){case 0:return[4,(0,j.jH)("Are you sure you want to delete this song?")];case 1:if(!e.sent())return[2];return A.k.removeSong(n.id),[2]}})}),children:[(0,g.jsx)(P.Xm5,{color:"#ed4557",style:{marginRight:"0.4rem"},size:14}),(0,g.jsx)(S.Qr,{text:"Delete"})]})]})})]})}var D=n(5684),K=n(1185),V=n(8949),W=n(4924),B=n(6305),$={amazing:300,perfect:200,great:100,good:50,bad:25,miss:0},U=function e(){var t=this;(0,o.Z)(this,e),this.keyboard=[],this.currentSong={song:null,type:"stop"},this.score={scoreVisible:!1,combo:0,score:0,amazing:0,perfect:0,great:0,good:0,bad:0,miss:0,lastScore:{timestamp:0,type:"",combo:0}},this.listeners=[],this.keyboardListeners=[],this.setLayout=function(e){var n;(n=t.keyboard).splice.apply(n,[0,t.keyboard.length].concat((0,B.Z)(e.map(function(e,t){return{key:e,index:t,isPressed:!1}}))))},this.addEventListener=function(e,n){t.listeners.push({callback:e,id:n})},this.emitEvent=function(e){t.listeners.forEach(function(t){return t.callback(e)})},this.removeEventListener=function(e){t.listeners=t.listeners.filter(function(t){return t.id!==e})},this.resetScore=function(){Object.assign(t.score,{scoreVisible:!1,score:0,amazing:0,perfect:0,great:0,good:0,bad:0,miss:0,combo:0,lastScore:{timestamp:0,type:"",combo:0}})},this.incrementScore=function(e){var n,r="miss"===e?0:t.score.combo+1;Object.assign(t.score,(n={},(0,W.Z)(n,e,t.score[e]+1),(0,W.Z)(n,"combo",r),(0,W.Z)(n,"score",t.score.score+t.getScore(e)*r),(0,W.Z)(n,"lastScore",{timestamp:Date.now(),type:e,combo:r}),n))},this.getScore=function(e){var t;return null!==(t=$[e])&&void 0!==t?t:0},this.playSong=function(e){t.currentSong.type="play",t.currentSong.song=e.clone()},this.showScore=function(){t.score.scoreVisible=!0},this.stopSong=function(){t.currentSong.type="stop",t.currentSong.song=null},this.pressKey=function(e){t.keyboard[e].isPressed=!0,t.emitKeyboardEvent(t.keyboard[e],"down")},this.releaseKey=function(e){t.keyboard[e].isPressed=!1,t.emitKeyboardEvent(t.keyboard[e],"up")},this.addKeyboardListener=function(e){t.keyboardListeners.push(e)},this.removeKeyboardListener=function(e){var n=t.keyboardListeners.findIndex(function(t){return t.id===e.id||t.callback===e.callback});-1!==n&&t.keyboardListeners.splice(n,1)},this.emitKeyboardEvent=function(e,n){t.keyboardListeners.forEach(function(t){return t.callback(e,n)})},(0,V.rC)(this)};(0,h.__decorate)([V.LO],U.prototype,"keyboard",void 0),(0,h.__decorate)([V.LO.shallow],U.prototype,"currentSong",void 0),(0,h.__decorate)([V.LO],U.prototype,"score",void 0);var J=new U,G=n(1328);function Q(e){var t,n,r,s=e.hitObjectSize,i=e.offset,a=e.keyboardLayout,o=e.verticalOffset,c=e.horizontalOffset,l=(n=(t=(0,m.Z)((0,f.useState)(J.keyboard),2))[0],r=t[1],(0,f.useEffect)(function(){var e;return e=(0,V.N7)(J.keyboard,function(){r((0,B.Z)(J.keyboard))}),r((0,B.Z)(J.keyboard)),e},[]),n);(0,f.useEffect)(function(){return G.w.listen(function(e){var t=e.letter;if(!e.event.repeat){var n=l.findIndex(function(e){return e.key===t});n>=0&&J.pressKey(n)}},{type:"keydown",id:"vsrg-player-keyboard"}),G.w.listen(function(e){var t=e.letter;if(!e.event.repeat){var n=l.findIndex(function(e){return e.key===t});n>=0&&J.releaseKey(n)}},{type:"keyup",id:"vsrg-player-keyboard"}),function(){G.w.unregisterById("vsrg-player-keyboard")}},[l]);var u=Math.ceil(l.length/2),d=l.length-2*u,h=l.slice(0,u),y=l.slice(u+d);return(0,g.jsxs)(g.Fragment,{children:["line"===a&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:"vsrg-player-keyboard-control-left",style:{"--vertical-offset":"calc(-".concat(2*h.length,"vw + ").concat(.1*o,"rem)"),"--horizontal-offset":"".concat(.1*c+1,"rem")},children:h.map(function(e){return(0,g.jsx)(X,{index:e.index,layout:l,offset:i,layoutType:"circles",size:s},"".concat(e.key,"-").concat(l.length))})}),(0,g.jsx)("div",{className:"vsrg-player-keyboard-control-right",style:{"--vertical-offset":"calc(-".concat(2*h.length,"vw + ").concat(.1*o,"rem)"),"--horizontal-offset":"".concat(.1*c+1,"rem")},children:y.map(function(e){return(0,g.jsx)(X,{index:e.index,layout:l,offset:i,layoutType:"circles",size:s},"".concat(e.key,"-").concat(l.length))})})]}),(0,g.jsx)("div",{className:"vsrg-player-keyboard-circles",children:l.map(function(e){return(0,g.jsx)(X,{index:e.index,layout:l,offset:i,layoutType:a,size:s},"".concat(e.key,"-").concat(l.length))})})]})}function X(e){var t,n,r,s=e.index,i=e.layout,a=e.size,o=e.layoutType,c=e.offset,u=(n=(t=(0,m.Z)((0,f.useState)(J.keyboard[s]),2))[0],r=t[1],(0,f.useEffect)(function(){var e;return e=(0,V.N7)(J.keyboard[s],function(){r((0,l.Z)({},J.keyboard[s])),r((0,l.Z)({},J.keyboard[s]))}),r((0,l.Z)({},J.keyboard[s])),e},[s,i]),n),d=(0,f.useCallback)(function(){J.pressKey(s)},[s]),h=(0,f.useCallback)(function(){J.releaseKey(s)},[s]);return"circles"===o?(0,g.jsx)("button",{className:"vsrg-player-key-hitbox-circle flex-centered",style:{paddingBottom:"".concat(c,"px")},onPointerDown:d,onPointerUp:h,children:(0,g.jsx)("div",{className:"vsrg-player-key-circle ".concat(u.isPressed?"vsrg-key-pressed":""),style:{width:a,height:a},children:u.key})}):"line"===o?(0,g.jsx)("button",{className:"vsrg-player-key-hitbox-line",onPointerDown:d,onPointerUp:h,children:(0,g.jsx)("div",{className:"vsrg-player-key-line ".concat(u.isPressed?"vsrg-key-pressed":""),style:{height:"".concat(c,"px")}})}):null}var q=n(8810),Y=n(5623),ee=n(8010),et=n(6743),en=n(9714),er=n(6767),es=n.n(er),ei=n(7564),ea=n(3531);ei.Xd.LINE_SCALE_MODE=ei.F4.NORMAL;var eo=function(){function e(t){var n=t.app,r=t.colors,s=t.sizes,i=t.trackColors,a=this;(0,o.Z)(this,e),this.destroy=function(){Object.values(a.textures.hitObjects).forEach(function(e){return null==e?void 0:e.destroy()}),Object.values(a.textures.heldHitObjects).forEach(function(e){return null==e?void 0:e.destroy()}),Object.values(a.textures.trails).forEach(function(e){return null==e?void 0:e.destroy()}),a.app=null},this.textures={hitObjects:{},heldHitObjects:{},trails:{},lines:{},sizes:{hitObject:0,trail:0}},this.trackColors=i,this.colors=r,this.sizes=s,this.app=n,this.generate()}var t=e.prototype;return t.generate=function(){var e=this.app;e&&(this.generateTrackCache(e),this.generateTrailsCache(e),this.generateLinesCache(e))},t.getHitObjectCache=function(e){return this.textures.hitObjects[e]||this.textures.hitObjects["#FF0000"]},t.getHeldTrailCache=function(e){return this.textures.trails[e]||this.textures.trails["#FF0000"]},t.getHeldHitObjectCache=function(e){return this.textures.heldHitObjects[e]||this.textures.heldHitObjects["#FF0000"]},t.getLinesCache=function(e){return this.textures.lines[e]||this.textures.lines["#FF0000"]},t.generateTrailsCache=function(e){var t=this,n=this.sizes,r=this.trackColors,s=(0,B.Z)(r).concat(["#FF0000"]),i=n.hitObjectSize,a=i/3;s.forEach(function(n){var r=new ei.K3;r.beginFill(es()(n).rgbNumber()).drawRect(a/2,0,i-a,i);var s=e.renderer.generateTexture(r,{resolution:1,scaleMode:ea.aH$.LINEAR,region:new ea.AeJ(0,0,i,i)});t.textures.trails[n]=s,r.destroy(!0)}),this.textures.sizes.trail=i},t.generateLinesCache=function(e){var t=this,n=this.sizes,r=this.trackColors;(0,B.Z)(r).concat(["#FF0000"]).forEach(function(r){var s=new ei.K3;s.lineStyle(5,es()(r).rgbNumber()).moveTo(0,0).lineTo(n.width,0);var i=e.renderer.generateTexture(s,{resolution:2,scaleMode:ea.aH$.LINEAR,region:new ea.AeJ(0,0,n.width,5)});t.textures.lines[r]=i,s.destroy(!0)})},t.generateTrackCache=function(e){var t=this,n=this.colors,r=this.sizes,s=this.trackColors,i=r.hitObjectSize;(0,B.Z)(s).concat(["#FF0000"]).forEach(function(r){var s=new ei.K3,a=i/2;s.lineStyle(5,es()(r).rgbNumber()).beginFill(n.background_10[1]).drawCircle(a,a,a-5);var o=e.renderer.generateTexture(s,{resolution:2,scaleMode:ea.aH$.LINEAR,region:new ea.AeJ(0,0,i,i)});t.textures.hitObjects[r]=o,s.destroy(!0);var c=new ei.K3,l=.7*i,u=(i-l)/2;c.lineStyle(5,es()(r).rgbNumber()).beginFill(n.background_10[1]).drawRoundedRect(u,u,l,l,6);var d=e.renderer.generateTexture(c,{resolution:2,scaleMode:ea.aH$.LINEAR,region:new ea.AeJ(0,0,i,i)});t.textures.heldHitObjects[r]=d,c.destroy(!0)}),this.textures.sizes.hitObject=i},e}();function ec(e){var t=e.timestamp,n=e.renderableHitObjects,r=e.cache,i=e.sizes,a=e.offset,o=i.scaling,c=i.hitObjectSize/2;return(0,g.jsx)(g.Fragment,{children:(0,g.jsx)(q.W2,{x:0,y:t*o+i.height-a,sortableChildren:!0,children:n.map(function(e,t){var a=e.hitObject,l=a.index*i.keyWidth+i.keyWidth/2,u=-(a.timestamp*o);if((e.status===s.Hit||e.status===s.Missed)&&!a.isHeld)return null;var d=e.hitObject.index,h=d,m=!0,y=!1,p=void 0;try{for(var b,v=n[Symbol.iterator]();!(m=(b=v.next()).done);m=!0){var x=b.value;x!==e&&x.status!==s.Missed&&x.status!==s.Hit&&x.hitObject.timestamp===a.timestamp&&(x.hitObject.index<d&&(d=x.hitObject.index),x.hitObject.index>h&&(h=x.hitObject.index))}}catch(e){y=!0,p=e}finally{try{m||null==v.return||v.return()}finally{if(y)throw p}}return(0,g.jsxs)(f.Fragment,{children:[d!==h&&(0,g.jsx)(q.jy,{texture:r.getLinesCache(e.color),x:d*i.keyWidth+i.keyWidth/2,width:(h-d)*i.keyWidth,zIndex:-1,y:u-c}),a.isHeld?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(q.jy,{texture:r.getHeldTrailCache(e.color),anchor:T.$n,width:r.textures.sizes.trail,height:a.holdDuration*o,x:l,y:u-c}),(0,g.jsx)(q.jy,{texture:r.getHeldHitObjectCache(e.color),anchor:.5,angle:45,x:l,y:u-c}),(0,g.jsx)(q.jy,{texture:r.getHeldHitObjectCache(e.color),anchor:T.$n,x:l,y:u-a.holdDuration*o})]}):(0,g.jsx)(q.jy,{texture:r.getHitObjectCache(e.color),y:u,anchor:T.$n,x:l},e.hitObject.renderId)]},a.renderId)})})})}var el=(0,f.memo)(function(e){var t=e.time,n=(0,f.useRef)(null);return(0,f.useEffect)(function(){var e=n.current;e&&e.animate([{transform:"scale(1.4)"},{transform:"scale(1)"}],{duration:500,iterations:1})},[t]),(0,g.jsx)(g.Fragment,{children:(0,g.jsx)("div",{className:"vsrg-player-countdown flex-centered",ref:n,children:t})})},function(e,t){return e.time===t.time});(r=s||(s={}))[r.Idle=0]="Idle",r[r.Pressed=1]="Pressed",r[r.Missed=2]="Missed",r[r.Hit=3]="Hit";var eu=function e(t){(0,o.Z)(this,e),this.color="#FFFFFF",this.status=s.Idle,this.instrumentIndex=0,this.heldScoreTimeout=0,this.hitObject=t},ed={el:(0,l.Z)({},T.n),rawWidth:0,rawHeight:0,width:0,height:0,keyWidth:0,hitObjectSize:0,scaling:0,verticalOffset:0},eh=function(e){(0,c.Z)(n,e);var t=(0,d.Z)(n);function n(e){var r;return(0,o.Z)(this,n),(r=t.call(this,e)).toDispose=[],r.onSongPick=function(e){var t=e.type,n=e.song;J.resetScore();var s=r.props.scrollSpeed;"play"===t&&n&&r.setState({song:n,timestamp:-1500-s,renderableHitObjects:[]},function(){n.startPlayback(0),r.calculateSizes(),r.generateAccuracyBounds()}),"stop"===t&&r.setState({song:new Y.Cz(""),timestamp:0,renderableHitObjects:[]})},r.handleVsrgEvent=function(e){"fpsChange"===e&&r.throttledEventLoop.changeMaxFps(r.props.maxFps)},r.handleKeyboard=function(e,t){var n=r.state,i=n.renderableHitObjects,a=n.timestamp,o=n.accuracy,c=i.find(function(t){return t.hitObject.index===e.index});if(c){if("down"===t){var l=(0,et.j$)(c.hitObject.timestamp,a,o),u=c.status===s.Idle;l&&u&&(c.hitObject.isHeld?c.status=s.Pressed:c.status=s.Hit,r.props.playHitObject(c.hitObject,c.instrumentIndex),J.incrementScore(r.getHitRating(c.hitObject,a)))}"up"===t&&c.hitObject.isHeld&&((0,et.j$)(c.hitObject.timestamp+c.hitObject.holdDuration,a,o)?c.status=s.Hit:(c.status=s.Missed,J.incrementScore("miss")))}},r.calculateSizes=function(){var e=r.wrapperRef.current;if(e){var t=e.clientWidth,n=t/r.state.song.keys,s={width:t,height:e.clientHeight,rawWidth:t,rawHeight:e.clientHeight,el:e.getBoundingClientRect(),keyWidth:n,hitObjectSize:.6*n,scaling:e.clientHeight/r.props.scrollSpeed,verticalOffset:15},i=e.querySelector("canvas");i&&(i.style.width="".concat(s.width,"px"),i.style.height="".concat(s.height,"px")),r.props.onSizeChange(s),r.setState({sizes:s},r.generateCache)}},r.generateCache=function(){var e=r.state,t=e.colors,n=e.sizes,s=e.cache,i=r.stageRef.current.app,a=new eo({app:i,colors:t,sizes:n,trackColors:r.state.song.tracks.map(function(e){return e.color})});r.setState({cache:a},function(){null==s||s.destroy()})},r.generateAccuracyBounds=function(){var e=r.state.song;r.setState({accuracyBounds:e.getAccuracyBounds()})},r.getHitRating=function(e,t){var n=r.state.accuracyBounds,s=Math.abs(t-e.timestamp);return s<n[0]?"amazing":s<n[1]?"perfect":s<n[2]?"great":s<n[3]?"good":s<n[4]?"bad":"miss"},r.handleThemeChange=function(e){var t=e.get("primary"),n=e.getText("primary"),s=n.darken(.5).desaturate(1),i=e.layer("background",.18,.06),a=t.darken(.15),o=a.darken(.1),c=e.get("secondary"),l=e.get("accent");r.setState({colors:{background_plain:[t.hex(),t.rgbNumber()],background_layer_10:[i.hex(),i.rgbNumber()],background:[a.hex(),a.rgbNumber()],background_10:[o.hex(),o.rgbNumber()],secondary:[c.hex(),c.rgbNumber()],lineColor:[n.hex(),n.rgbNumber()],lineColor_10:[s.hex(),s.rgbNumber()],accent:[l.hex(),l.rgbNumber()]}},r.generateCache)},r.handleTick=function(e,t){var n=r.props,s=n.isPlaying,i=n.scrollSpeed,a=r.state,o=a.song,c=a.renderableHitObjects,l=a.sizes;if(s){var u=r.state.timestamp+t,d=o.tickPlayback(u+i+l.height).map(function(e,t){return e.map(function(e){var n=new eu(e);return n.instrumentIndex=t,n.color=o.tracks[t].color,n})}).flat();r.validateHitObjects(u,c.concat(d),r.state.timestamp),r.props.onTick(u)}},r.validateHitObjects=function(e,t,n){for(var i=r.state.accuracy,a=J.keyboard,o=0;o<t.length;o++){var c=t[o],l=a[c.hitObject.index];if(l){var u=c.status===s.Idle;if(!l.isPressed&&u&&c.hitObject.timestamp<e-i){c.status=s.Missed,J.incrementScore("miss");continue}if(l.isPressed&&c.status===s.Pressed){var d=c.hitObject.timestamp+c.hitObject.holdDuration<e-i;c.heldScoreTimeout-=e-n,d?(c.status=s.Missed,J.incrementScore("miss")):c.heldScoreTimeout<=0&&(c.heldScoreTimeout=300,J.incrementScore("perfect"));continue}}}var h=t.filter(function(t){return t.hitObject.timestamp+t.hitObject.holdDuration>e-i});r.setState({timestamp:e,renderableHitObjects:h})},r.state={song:new Y.Cz(""),timestamp:0,devicePixelRatio:1.4,accuracy:150,sizes:ed,colors:{background_plain:["#000000",1],background_layer_10:["#000000",1],background:["#000000",1],background_10:["#000000",1],secondary:["#000000",1],lineColor:["#000000",1],lineColor_10:["#000000",1],accent:["#000000",1]},accuracyBounds:[0,0,0,0,0],cache:null,renderableHitObjects:[]},r.throttledEventLoop=new ee.v(function(){},r.props.maxFps),r.wrapperRef=(0,f.createRef)(),r.stageRef=(0,f.createRef)(),r}var r=n.prototype;return r.componentDidMount=function(){var e,t,n=this;this.throttledEventLoop.setCallback(this.handleTick),this.throttledEventLoop.start(),J.addKeyboardListener({callback:this.handleKeyboard,id:"vsrg-player-canvas"}),this.setState({devicePixelRatio:null!==(t=window.devicePixelRatio)&&void 0!==t?t:1.4}),this.toDispose.push(function(){return J.removeKeyboardListener({id:"vsrg-player-canvas"})}),this.toDispose.push((e=this.onSongPick,(0,V.N7)(J.currentSong,function(){e(J.currentSong)}))),this.toDispose.push((0,Z.B)(this.handleThemeChange)),J.addEventListener(this.handleVsrgEvent,"vsrg-player-canvas"),this.toDispose.push(function(){return J.removeEventListener("vsrg-player-canvas")}),window.addEventListener("resize",this.calculateSizes),this.toDispose.push(function(){return window.removeEventListener("resize",n.calculateSizes)}),this.calculateSizes()},r.componentWillUnmount=function(){this.throttledEventLoop.stop(),J.setLayout(en.z.getVsrgKeybinds(4)),this.toDispose.forEach(function(e){return e()})},r.render=function(){var e=this.state,t=e.sizes,n=e.cache,r=e.renderableHitObjects,s=e.timestamp,i=e.colors,a=e.devicePixelRatio,o=this.props.scrollSpeed;return(0,g.jsx)(g.Fragment,{children:(0,g.jsxs)("div",{className:"vsrg-player-canvas box-shadow",style:{backgroundColor:i.background_layer_10[0]},ref:this.wrapperRef,children:[s+o<0&&(0,g.jsx)(el,{time:Math.abs(Math.ceil((s+o)/1e3*2))+1}),(0,g.jsx)(q.Hf,{ref:this.stageRef,raf:!1,width:t.width,height:t.height,options:{backgroundAlpha:0,autoDensity:!1,resolution:a},onMount:this.calculateSizes,children:n&&(0,g.jsx)(g.Fragment,{children:(0,g.jsx)(ec,{sizes:t,offset:t.verticalOffset,cache:n,renderableHitObjects:r,timestamp:s})})})]})})},n}(f.Component),eg=n(2881),ef=n(8778),em=n(3337),ey=(0,f.memo)(function(){var e,t,n,r=(t=(e=(0,m.Z)((0,f.useState)(J.score),2))[0],n=e[1],(0,f.useEffect)(function(){return(0,V.N7)(J.score,function(){n((0,l.Z)({},J.score))})},[]),t);return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:"vsrg-player-score",children:(0,g.jsx)("div",{className:"column space-between",children:(0,g.jsx)("div",{children:r.score})})}),r.scoreVisible&&(0,g.jsxs)("div",{className:"vsrg-final-score box-shadow",children:[(0,g.jsx)(ep,{text:"Amazing",number:r.amazing,color:T.fA.amazing,gridArea:"a"}),(0,g.jsx)(ep,{text:"Perfect",number:r.perfect,color:T.fA.perfect,gridArea:"b"}),(0,g.jsx)(ep,{text:"Great",number:r.great,color:T.fA.great,gridArea:"c"}),(0,g.jsx)(ep,{text:"Good",number:r.good,color:T.fA.good,gridArea:"d"}),(0,g.jsx)(ep,{text:"Miss",number:r.miss,color:T.fA.miss,gridArea:"e"}),(0,g.jsxs)("div",{className:"row space-between",style:{width:"100%",alignItems:"center",gridArea:"f"},children:[(0,g.jsxs)("div",{style:{fontSize:"1.2rem"},children:["Combo: ",r.combo,"x"]}),(0,g.jsx)("div",{className:"flex",style:{fontSize:"0.8rem",alignItems:"center"},children:r.score})]})]})]})},function(e,t){return!1});function ep(e){var t=e.text,n=e.color,r=e.number,s=e.gridArea;return(0,g.jsxs)("div",{className:"row floating-score-element",style:{gridArea:s},children:[(0,g.jsx)("span",{style:{color:n},children:t}),(0,g.jsx)("span",{children:r})]})}function eb(e){var t=e.song,n=e.onStopSong,r=e.onRetrySong;return t?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:"vsrg-player-right",children:(0,g.jsxs)("div",{className:"row space-between",style:{gap:"0.2rem"},children:[(0,g.jsx)(em.h,{onClick:n,children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(P.JuG,{})})}),(0,g.jsx)(em.h,{onClick:r,children:(0,g.jsx)(k.Z,{children:(0,g.jsx)(P.dnK,{})})})]})}),(0,g.jsx)(ey,{})]}):null}var ev={transform:"rotate(0) scale(1)",color:"var(--primary-text)"},ex=(0,f.memo)(function(){var e=(0,m.Z)((0,f.useState)(J.score.lastScore),2),t=e[0],n=e[1],r=(0,f.useRef)(null),s=(0,m.Z)((0,f.useState)(ev),2),i=s[0],a=s[1];return(0,f.useEffect)(function(){var e,t=0,r=(e=function(e){n(e),clearTimeout(t),t=setTimeout(function(){n((0,u.Z)((0,l.Z)({},e),{type:""}))},800)},(0,V.N7)(J.score,function(){e((0,l.Z)({},J.score.lastScore))}));return function(){r(),clearTimeout(t)}},[]),(0,f.useEffect)(function(){var e=r.current;if(e){var n=Math.floor(25*Math.random()-12.5);e.animate([i,{transform:"rotate(".concat(n,"deg) scale(1.3)"),color:T.fA[t.type]},{transform:"rotate(0) scale(1)",color:T.fA[t.type]}],{duration:150,easing:"ease-out"}),a({transform:"rotate(".concat(n,"deg)"),color:T.fA[t.type]})}},[t]),(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{ref:r,style:i,className:"vsrg-floating-score",children:t.type}),(0,g.jsx)("div",{className:"vsrg-floating-combo",children:t.combo>0&&"".concat(t.combo,"x")})]})},function(e,t){return!1}),ej=n(4995),eS=n(6880),ek=function(e){(0,c.Z)(n,e);var t=(0,d.Z)(n);function n(e){(0,o.Z)(this,n),(s=t.call(this,e)).lastTimestamp=0;var r,s,c=(0,i.Z)(s);return s.onSongSelect=(r=(0,a.Z)(function(e,t){var n,r,s,i,a,o;return(0,h.__generator)(this,function(l){switch(l.label){case 0:return r=(n=c.state).songAudioPlayer,s=n.keyboardAudioPlayer,[4,A.k.getSongById(e.audioSongId)];case 1:if(i=l.sent(),R.kg.showPill("Loading instruments..."),!i)return[3,6];if(a=L.v.parseSong(i),r.basePitch=a.pitch,!(a instanceof eg.M))return[3,3];return c.setState({audioSong:a}),[4,r.syncInstruments(a.instruments)];case 2:l.sent(),l.label=3;case 3:if(!(a instanceof ef.l))return[3,5];return o=a.toRecordedSong(0),c.setState({audioSong:o}),[4,r.syncInstruments(o.instruments)];case 4:l.sent(),l.label=5;case 5:return[3,7];case 6:c.setState({audioSong:null}),l.label=7;case 7:return[4,s.syncInstruments(e.tracks.map(function(e){return e.instrument}))];case 8:return l.sent(),R.kg.hidePill(),c.setState({song:e,isPlaying:!0},function(){"play"===t&&(J.setLayout(en.z.getVsrgKeybinds(e.keys)),J.playSong(e))}),[2]}})}),function(e,t){return r.apply(this,arguments)}),s.handleSettingChange=function(e){var t=s.state.settings,n=e.data;t[e.key]=(0,u.Z)((0,l.Z)({},t[e.key]),{value:n.value}),s.setState({settings:(0,l.Z)({},t)},function(){s.updateSettings(),"maxFps"===e.key&&J.emitEvent("fpsChange")})},s.updateSettings=function(e){D.j.updateVsrgPlayerSettings(void 0!==e?e:s.state.settings)},s.onSizeChange=function(e){s.setState({canvasSizes:e})},s.onStopSong=function(){s.setState({isPlaying:!1,song:null},function(){J.stopSong()})},s.onRetrySong=function(){var e=s.state.song;e&&s.onSongSelect(e,"play")},s.handleTick=function(e){var t=s.state,n=t.audioSong,r=t.songAudioPlayer,i=t.song,a=t.settings;s.lastTimestamp=e,i&&(s.lastTimestamp>=i.duration+2e3&&(s.setState({isPlaying:!1}),J.showScore()),s.lastTimestamp>=i.duration||e<0||!n||n.tickPlayback(e+a.offset.value).forEach(function(e){e.layer.toArray().forEach(function(t,n){0===t||i.trackModifiers[n].muted||r.playNoteOfInstrument(n,e.index)})}))},s.playHitObject=function(e,t){var n=s.state.keyboardAudioPlayer;n&&e.notes.forEach(function(e){n.playNoteOfInstrument(t,e)})},s.state={song:null,audioSong:null,settings:D.j.getDefaultVsrgPlayerSettings(),canvasSizes:ed,songAudioPlayer:new K.z("C"),keyboardAudioPlayer:new K.z("C"),currentLayout:en.z.getVsrgKeybinds(4),isPlaying:!1},s}var r=n.prototype;return r.componentDidMount=function(){this.setState({settings:D.j.getVsrgPlayerSettings()}),J.setLayout(this.state.currentLayout)},r.componentWillUnmount=function(){var e=this.state,t=e.songAudioPlayer,n=e.keyboardAudioPlayer;t.destroy(),n.destroy(),J.resetScore(),R.kg.hidePill()},r.render=function(){var e=this.state,t=e.canvasSizes,n=e.settings;return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(ej.D,{text:"Vsrg Player"}),(0,g.jsxs)("div",{className:"vsrg-player-page",children:[(0,g.jsx)(I,{settings:n,onSettingsUpdate:this.handleSettingChange,onSongSelect:this.onSongSelect}),(0,g.jsxs)("div",{className:"vsrg-player-grid",children:[(0,g.jsx)(eh,{keyboardLayout:n.keyboardLayout.value,onTick:this.handleTick,maxFps:n.maxFps.value,scrollSpeed:n.approachTime.value,onSizeChange:this.onSizeChange,playHitObject:this.playHitObject,isPlaying:this.state.isPlaying}),(0,g.jsx)(Q,{keyboardLayout:n.keyboardLayout.value,offset:t.verticalOffset,hitObjectSize:t.hitObjectSize,verticalOffset:n.verticalOffset.value,horizontalOffset:n.horizontalOffset.value})]}),(0,g.jsx)(eb,{song:this.state.song,onStopSong:this.onStopSong,onRetrySong:this.onRetrySong}),(0,g.jsx)(ex,{})]})]})},n}(f.Component);function ew(){return(0,g.jsx)(ek,{})}ew.getLayout=function(e){return(0,g.jsx)(eS.Z,{page:"Main",children:e})}}},function(e){e.O(0,[749,962,26,774,888,179],function(){return e(e.s=9406)}),_N_E=e.O()}]);